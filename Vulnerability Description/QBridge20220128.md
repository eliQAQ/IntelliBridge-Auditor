## 攻击核心
QBridge攻击的核心在于利用合约对原生代币(ETH)和普通ERC20代币处理逻辑的不一致性，通过精心构造的恶意输入绕过安全检查。

## 攻击流程
1. 攻击者通过 ETH 上的 QBridge 合约进行存款操作，存款时传入所要跨的目标链 destinationDomainID、所要跨链的资产 resourceID 以及跨链资金数量与接收地址等参数构成的 data。

2. 攻击者指定传入的 resourceID 为跨 ETH Token 所需要的值，但其调用的是 QBridge 的 deposit 函数而非 depositETH 函数，因此首先绕过了跨链资金数量与 msg.value 的检查。deposit 函数会根据 resourceID 从映射中取出 handler 地址进行充值，由于攻击者传入的是真实的跨 ETH Token 所需要的值所以可以顺利调用 handler 合约的 deposit 函数。

3. handler 合约的 deposit 函数中会根据 resourceID 取出的所要充值的 Token 是否在白名单内进行检查，由于攻击者传入的 resourceID 对应 ETH，因此映射中取出的所要充值的 Token 为 0 地址，交易执行成功说明 0 地址也在白名单之中，即白名单校验是通过的, 之所以出现tokenAddress地址为0的情况，是因为在存入Ether的时候，默认Ether的地址为零地址, 即会被认为是充值 ETH 而通过了白名单检查。但 deposit 函数中却并没有对所要充值的 Token 地址再次进行检查（充值 ETH 应该是要通过 depositETH 函数进行跨链），随后直接通过 safeTransferFrom 调用了所要充值的 Token 的 transferFrom 函数。

4. 由于所要充值的 Token 地址为 0 地址，而 call 调用无 code size 的 EOA 地址时其执行结果都会为 true 且返回值为空，因此通过 transferFrom 的转账操作通过了 safeTransferFrom 的检查，最后触发了 Deposit 跨链充值事件。

5. 由于传入的 resourceID 为跨 ETH 所需要的值，因此触发的 Deposit 事件与真正充值 ETH 的事件相同，这让 QBridge 认为攻击者进行了 ETH 跨链，因此在 BSC 链上为攻击者凭空铸造了大量的 qXETH Token。攻击者利用此 qXETH 凭证从Qubit的借贷池中借出并转移了大量其他资产。


## 代码分析
我们对比一下`0x80D1486eF600cc56d4df9ed33bAF53C60D5A629b
/QBridgeHandler.sol`中的deposit和depositETH函数：
```
function deposit(bytes32 resourceID, address depositer, bytes calldata data) external override onlyBridge {
    uint option;
    uint amount;
    (option, amount) = abi.decode(data, (uint, uint));

    address tokenAddress = resourceIDToTokenContractAddress[resourceID];
    require(contractWhitelist[tokenAddress], "provided tokenAddress is not whitelisted");

    if (burnList[tokenAddress]) {
        require(amount >= withdrawalFees[resourceID], "less than withdrawal fee");
        QBridgeToken(tokenAddress).burnFrom(depositer, amount);
    } else {
        require(amount >= minAmounts[resourceID][option], "less than minimum amount");
        tokenAddress.safeTransferFrom(depositer, address(this), amount);
    }
}
```

```
 function depositETH(bytes32 resourceID, address depositer, bytes calldata data) external payable override onlyBridge {
    uint option;
    uint amount;
    (option, amount) = abi.decode(data, (uint, uint));
    require(amount == msg.value);

    address tokenAddress = resourceIDToTokenContractAddress[resourceID];
    require(contractWhitelist[tokenAddress], "provided tokenAddress is not whitelisted");

    require(amount >= minAmounts[resourceID][option], "less than minimum amount");
}
```
可以发现deposit相比depositETH函数确实没有`require(amount == msg.value);`，且之后并没有他别的检查。

由`0x99309d2e7265528dC7C3067004cC4A90d37b7CC3
/QBridge-label.sol`
中的deposit函数可知会触发Deposit事件，且与depositETH触发的事件相同：
```
function deposit(uint8 destinationDomainID, bytes32 resourceID, bytes calldata data) external payable notPaused {
    // AC inconsistency
    require(msg.value == fee, "QBridge: invalid fee");

    address handler = resourceIDToHandlerAddress[resourceID];
    require(handler != address(0), "QBridge: invalid resourceID");

    uint64 depositNonce = ++_depositCounts[destinationDomainID];

    IQBridgeHandler(handler).deposit(resourceID, msg.sender, data);
    //DF inconsistency
    emit Deposit(destinationDomainID, resourceID, depositNonce, msg.sender, data);
}
```

```
function depositETH(uint8 destinationDomainID, bytes32 resourceID, bytes calldata data) external payable notPaused {
    uint option;
    uint amount;
    (option, amount) = abi.decode(data, (uint, uint));
    // AC inconsistency
    require(msg.value == amount.add(fee), "QBridge: invalid fee");

    address handler = resourceIDToHandlerAddress[resourceID];
    require(handler != address(0), "QBridge: invalid resourceID");

    uint64 depositNonce = ++_depositCounts[destinationDomainID];

    IQBridgeHandler(handler).depositETH{value:amount}(resourceID, msg.sender, data);
    //DF inconsistency
    emit Deposit(destinationDomainID, resourceID, depositNonce, msg.sender, data);
}
```

## 参考交易
<https://etherscan.io/tx/0x478d83f2ad909c64a9a3d807b3d8399bb67a997f9721fc5580ae2c51fab92acf>  
<https://bscscan.com/tx/0x33628dcc2ca6cd89a96d241bdf17cdc8785cf4322dcaf2c79766c990579aea02>

## 参考资料
<https://www.freebuf.com/articles/blockchain-articles/323853.html>
<https://www.odaily.news/post/5176008>