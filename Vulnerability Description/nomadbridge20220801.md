​

### 历年跨链合约恶意交易详解（三）——Nomad Bridge20220801

### **漏洞合约函数**

```
/**
     * @notice Given formatted message, attempts to dispatch
     * message payload to end recipient.
     * @dev Recipient must implement a `handle` method (refer to IMessageRecipient.sol)
     * Reverts if formatted message's destination domain is not the Replica's domain,
     * if message has not been proven,
     * or if not enough gas is provided for the dispatch transaction.
     * @param _message Formatted message
     * @return _success TRUE iff dispatch transaction succeeded
     */
    function process(bytes memory _message) public returns (bool _success) {
        // ensure message was meant for this domain
        bytes29 _m = _message.ref(0);
        require(_m.destination() == localDomain, "!destination");
        // ensure message has been proven
        bytes32 _messageHash = _m.keccak();
        require(acceptableRoot(messages[_messageHash]), "!proven");
        // check re-entrancy guard
        require(entered == 1, "!reentrant");
        entered = 0;
        // update message status as processed
        messages[_messageHash] = LEGACY_STATUS_PROCESSED;
        // call handle function
        IMessageRecipient(_m.recipientAddress()).handle(
            _m.origin(),
            _m.nonce(),
            _m.sender(),
            _m.body().clone()
        );
        // emit process results
        emit Process(_messageHash, true, "");
        // reset re-entrancy guard
        entered = 1;
        // return true
        return true;
    }
```

![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")

```
function initialize(
        uint32 _remoteDomain,
        address _updater,
        bytes32 _committedRoot,
        uint256 _optimisticSeconds
    ) public initializer {
        __NomadBase_initialize(_updater);
        // set storage variables
        entered = 1;
        remoteDomain = _remoteDomain;
        committedRoot = _committedRoot;
        // pre-approve the committed root.
        if (_committedRoot != bytes32(0)) confirmAt[_committedRoot] = 1;
        _setOptimisticTimeout(_optimisticSeconds);
    }
```

![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")

```
/**
     * @notice Check that the root has been submitted
     * and that the optimistic timeout period has expired,
     * meaning the root can be processed
     * @param _root the Merkle root, submitted in an update, to check
     * @return TRUE iff root has been submitted & timeout has expired
     */
    function acceptableRoot(bytes32 _root) public view returns (bool) {
        // this is backwards-compatibility for messages proven/processed
        // under previous versions
        if (_root == LEGACY_STATUS_PROVEN) return true;
        if (_root == LEGACY_STATUS_PROCESSED || _root == LEGACY_STATUS_NONE)
            return false;

        uint256 _time = confirmAt[_root];
        if (_time == 0) {
            return false;
        }
        return block.timestamp >= _time;
    }
```

![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")

### **相关交易与地址**

**​攻击者地址:​**[0xb5c55f76f90cc528b2609109ca14d8d84593590e](https://etherscan.io/address/0xb5c55f76f90cc528b2609109ca14d8d84593590e "0xb5c55f76f90cc528b2609109ca14d8d84593590e")

**​漏洞合约地址：​**[0x88A69B4E698A4B090DF6CF5Bd7B2D47325Ad30A3](https://etherscan.io/address/0x88a69b4e698a4b090df6cf5bd7b2d47325ad30a3 "0x88A69B4E698A4B090DF6CF5Bd7B2D47325Ad30A3")

**执行的恶意交易：**

![](https://i-blog.csdnimg.cn/direct/c3592ed5b3ed4756a5bf504617096ef9.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

**具体细节分析**

跨链桥调用initialize函数初始化时将confirmAt[0]设置成了1，而又在acceptableRoot函数里，对于给定的参数\_root，当confirmAt[\_root]=1的时候，该函数即返回true。所以对于处理跨链消息的process函数来讲，其调用require(acceptableRoot(messages[\_messageHash]), "!proven");来判断验证消息的正确性，攻击者即可通过设置message的格式，令\_messageHash对应的值为0即可通过该验证，从而构造出含任意跨链交易的消息。

![](https://i-blog.csdnimg.cn/direct/11777a3cbc324baea22a8f5b87cb994b.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

攻击产生的事件：

![](https://i-blog.csdnimg.cn/direct/753f9be36a4a40f19ee2c48fc3ac9365.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

### **参考链接**

[https://etherscan.io/](https://etherscan.io/ "https://etherscan.io/")

[https://www.coinbase.com/blog/nomad-bridge-incident-analysis](https://www.coinbase.com/blog/nomad-bridge-incident-analysis "https://www.coinbase.com/blog/nomad-bridge-incident-analysis")

​

