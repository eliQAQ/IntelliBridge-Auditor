## 攻击过程
攻击者闪电贷了价值 750 万美元的 BUSD，在 0x2c3c-pool 中将 200 万美元的 BUSD 兑换为 200 万美元的 $BSC-USD，并存入 0xb19c-pool。然后，他将 500 万美元的 BUSD 存入 0x179ac-pool。


然后，攻击者在 Allbridge 的 Bridge 合约中将 50 万美元的 BSC-USD 兑换为 $BUSD。此时，0x179ac 池 中的 tokenBalance(BUSD) 增加，而 vUSD 的数量减少。
然后，攻击者从 0x179a 池 中移除流动性，这加剧了 vUSDbalance 和 tokenbalance 之间的不平衡。因此，vUSD/BUSD 的比率显著增加。


由于比率的变化，攻击者设法仅使用价值 40,000 美元的 BUSD 从 ALLBridge 中换取了价值 790,000 美元的 BSC-USD，并且他从 0xb19c-pool 中提取了 190 万美元的USDT。然后，攻击者将270万美元的USDT 兑换为 270 万美元的 $BUSD。最后，他们偿还了闪电贷，并将剩余的余额作为利润保留。

攻击者向 Tornado Cash 发送了 1,700 BNB（其中包括先前攻击的利润）。

## 漏洞分析
合约中执行兑换操作函数 swapToVUsd 中计算兑换结果方式为合约中当前记录 BUSD 余额与计算转入 token 后的数量转换为 BUSD 的差值得到的，因此攻击者通过存取大量资金以及进行大量代币兑换实现对池子中代币价格控制。
```
    function swapToVUsd(address user, uint256 amount) external onlyRouter returns (uint256) {
        uint256 result; // 0 by default
        uint256 fee;
        if (amount > 0) {
            fee = amount * feeShareBP / BP;
            uint256 amountIn = toSystemPrecision(amount - fee);
            // Incorporate rounding dust into the fee
            fee = amount - fromSystemPrecision(amountIn);

            tokenBalance += amountIn;
            uint256 vUsdNewAmount = this.getY(tokenBalance);
            if (vUsdBalance > vUsdNewAmount) {
                result = vUsdBalance - vUsdNewAmount;
            }
            vUsdBalance = vUsdNewAmount;
            token.safeTransferFrom(user, address(this), amount);
            _addRewards(fee);
        }

        emit SwappedToVUsd(user, address(token), amount, result, fee);
        return result;
    }
```
问题的根本原因则是Pool.sol中withdraw函数的逻辑缺陷。这个缺陷允许操纵池的交换价格。攻击者充当流动性提供者和交换者，使他们能够操纵价格并耗尽池中的资金。

![](https://miro.medium.com/v2/resize:fit:1100/format:webp/1*r6No2i4yaXqWojbTMxBxQg.png)

链上细节：

BUSD & vUSD 池： 0x179aad597399b9ae078acfe2b746c09117799ca0

USDT & vUSD 池： 0xb19cd6ab3890f18b662904fd7a40c003703d2554

Bridge 合约： 0x7E6c2522fEE4E74A0182B9C6159048361BC3260A

攻击者 EOA 1： 0xC578d755Cd56255d3fF6E92E1B6371bA945e3984
攻击者 EOA 2： 0x2b3cff12c02625518deb0af14684999fb6e3e360

攻击 Txn： 0x7ff1364c3b3b296b411965339ed956da5d17058f3164425ce800d64f1aef8210

## 参考链接
https://learnblockchain.cn/article/14297

https://medium.com/coinmonks/decoding-allbridge-570k-flash-loan-exploit-quillaudits-8da8dccd729d

https://zhuanlan.zhihu.com/p/658466008