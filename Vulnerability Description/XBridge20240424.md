​

### 历年跨链合约恶意交易详解（二）——XBridge20240424攻击

### **漏洞合约函数**

```
/**
     * @dev token owner can list the pair of their token with their corresponding chain id
     * @param baseToken struct that contains token address and its corresponding chain id
     * @param correspondingToken struct that contains token address and its corresponding chain id
     * @param _isMintable if corresponding token address is mintable then its `true` otherwise `false`
     */
    function listToken(tokenInfo memory baseToken, tokenInfo memory correspondingToken, bool _isMintable) external payable {
        address _baseToken = baseToken.token;
        address _correspondingToken = correspondingToken.token;
        require(_baseToken != address(0), "INVALID_ADDR");
        require(_correspondingToken != address(0), "INVALID_ADDR");
        require(tokenToTokenWithChainId[baseToken.chain][correspondingToken.chain][_baseToken] == address(0) && tokenToTokenWithChainId[baseToken.chain][correspondingToken.chain][_correspondingToken] == address(0), "THIS_PAIR_ALREADY_LISTED");

        isMintableWithChainId[baseToken.chain][correspondingToken.chain][_baseToken][_correspondingToken] = _isMintable;
        isMintableWithChainId[baseToken.chain][correspondingToken.chain][_correspondingToken][_baseToken] = _isMintable;
        isMintableWithChainId[correspondingToken.chain][baseToken.chain][_baseToken][_correspondingToken] = _isMintable;
        isMintableWithChainId[correspondingToken.chain][baseToken.chain][_correspondingToken][_baseToken] = _isMintable;

        tokenToTokenWithChainId[baseToken.chain][correspondingToken.chain][_baseToken] = _correspondingToken;
        tokenToTokenWithChainId[baseToken.chain][correspondingToken.chain][_correspondingToken] = _baseToken;
        tokenToTokenWithChainId[correspondingToken.chain][baseToken.chain][_baseToken] = _correspondingToken;
        tokenToTokenWithChainId[correspondingToken.chain][baseToken.chain][_correspondingToken] = _baseToken;


        if(_isMintable) {
            isWrappedWithChainId[baseToken.chain][correspondingToken.chain][_correspondingToken] = true;
            isWrappedWithChainId[correspondingToken.chain][baseToken.chain][_correspondingToken] = true;
            isWrapped[_correspondingToken] = true;

        }

        tokenOwnerWithChainId[baseToken.chain][correspondingToken.chain][_baseToken][_correspondingToken] = msg.sender;
        tokenOwnerWithChainId[baseToken.chain][correspondingToken.chain][_correspondingToken][_baseToken] = msg.sender;
        tokenOwnerWithChainId[correspondingToken.chain][baseToken.chain][_baseToken][_correspondingToken] = msg.sender;
        tokenOwnerWithChainId[correspondingToken.chain][baseToken.chain][_correspondingToken][_baseToken] = msg.sender;

        if(_baseToken == _correspondingToken) _tokenOwner[_baseToken] = msg.sender;
        else {
            if(_baseToken.code.length > 0) _tokenOwner[_baseToken] = msg.sender;
            else _tokenOwner[_correspondingToken] = msg.sender;
        }

        if(!excludeFeeFromListing[msg.sender]) transferListingFee(listingFeeCollector, msg.sender, msg.value);

        emit TokenListed(_baseToken, baseToken.chain, _correspondingToken, correspondingToken.chain, _isMintable, msg.sender);

    }
```

![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")

```
/**
    * @dev token lister can withdraw tokens 
    * @param token token address to withdraw from bridge contract 
    * @param receiver address to recive the withdrawn tokens
    * @param amount amount of tokens to deposit in bridge contract
    */
    function withdrawTokens(address token, address receiver, uint256 amount) external {
        // require(token.code.length > 0, "TOKEN_NOT_DEPLOYED_ON_THIS_CHAIN");
        // address _correspondingToken = tokenToTokenWithChainId[srcId][dstId][token];
        require(token != address(0), "TOKEN_NOT_LISTED");
        require(amount > 0, "AMOUNT_CANT_BE_ZERO");
        address user = msg.sender;
        require(user == _tokenOwner[token], "ONLY_TOKEN_LISTER_CAN_WITHDRAW");
        // require(user == tokenOwnerWithChainId[srcId][dstId][token][_correspondingToken], "ONLY_TOKEN_LISTER_CAN_WITHDRAW");

        if(token != native) {

            require(amount <= (IERC20(token).balanceOf(address(this)) - tokenTax[token]), "WITHDRAW_LESS");

            if(isWrapped[token]) revert("CANT_WITHDRAW_WRAPPED_TOKENS");

            IERC20(token).transfer(receiver, amount);
        } else {
            require(amount <= address(this).balance, "WITHDRAW_LESS");
            (bool success, ) = payable(receiver).call{value: amount}("");
            require(success, "WITHDRAW_FAILED");
        }

        emit TokenWithdrawn(user, receiver, amount);
    }
```

![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")

### **相关交易与地址**

**​攻击者地址：​**[0x0cFC28d16d07219249c6D6d6AE24E7132EE4CaA7](https://etherscan.io/address/0x0cfc28d16d07219249c6d6d6ae24e7132ee4caa7 "0x0cFC28d16d07219249c6D6d6AE24E7132EE4CaA7")

**​漏洞合约地址：​**[0x354CCA2F55ddE182d36fE34D673430E226a3cB8C](https://etherscan.io/address/0x354cca2f55dde182d36fe34d673430e226a3cb8c#code "0x354CCA2F55ddE182d36fE34D673430E226a3cB8C")

**执行的恶意交易：**

![](https://i-blog.csdnimg.cn/direct/fb69d99859544bcda36154030a3589c1.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

![](https://i-blog.csdnimg.cn/direct/74c7d520419c433682a707a59d71af12.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

**具体细节分析**

非常明显的访问控制漏洞。在 listToken函数中，由于未对合约所有者的设置进行访问控制，任何用户只要提交满足\_baseToken==\_correspondingToken条件的参数，就能将自己设为该 token 的所有者，随后再通过调用withdrawTokens函数将代币转移到自己的地址。

攻击产生的事件：

![](https://i-blog.csdnimg.cn/direct/fe3b3b647f96480fb9151459c004f1bd.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

![](https://i-blog.csdnimg.cn/direct/330e5bee0ad44f42844efd5978a84e0b.png)![](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw== "点击并拖拽以移动")​**编辑**

### **参考链接**

[https://etherscan.io/](https://etherscan.io/ "https://etherscan.io/")

[https://neptunemutual.com/blog/understanding-the-xbridge-exploit/](https://neptunemutual.com/blog/understanding-the-xbridge-exploit/ "https://neptunemutual.com/blog/understanding-the-xbridge-exploit/")

​

