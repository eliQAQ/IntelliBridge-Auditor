Curve 的 MetaPool 是在 Vyper 中实现的。为了支持 Solidity 的开发，Saddle.Finance 的开发团队使用 Solidity 重写了代码。它已经分别被 Synapse 和 Nerve 分叉采用，其漏洞导致了对于Synapse 和 Nerve的攻击。

在 MetaPool 中，有两个重要的功能，即swap和swapUnderlying。具体来说，前者用于交换 LP 代币和矿池稳定币，而后者用于交换矿池稳定币和底层稳定币。该池子 fUSDT 是矿池稳定币，而 BUSD、USD 和 USDC 是底层稳定币。

swap函数：
![swap：_calculateSwap 函数](https://assets.blocksec.com/frontend/blocksec-strapi-online/1_z_Z0vpop_D_Kz_I_Prgh_Kexl_Nw_f397a7021a.webp)

swapUnderlaying函数：
![swapUnderlaying：_calculateSwapUnderlying 函数](https://assets.blocksec.com/frontend/blocksec-strapi-online/1_w_Sl_C8hl8r_N9k_SQR_2gx_x_RQ_f37e4503a2.webp)

虚拟价格 = 池的总价值 / LP代币总量 （一般情况下大于1）  
当虚拟价格=1时，表示池价值等于所有存入资产，尚未产生收益  
当虚拟价格>1时(如1.5)，表示池价值比初始存入增长了50%，LP代币价值相应增加  
当虚拟价格<1时，表示池价值相比存入资产有所损失

这两个函数对于价值的实现不一致。如上两张图所示。红色矩形中的代码片段用于通过测量 LP 代币的“虚拟价格”（随着费用的增加，该价格从基线值 1 增加）来调整 LP 代币的价值。同时，而swap函数忽略了虚拟价格的影响，这意味着 LP 代币的价值将被低估。换句话说，可以换出更多的 LP 代币。

因此，可以通过先用相应的 LP 代币取回底层稳定币的流动性，然后通过调用swapUnderlying函数来交换矿池稳定币，从而收获更多的矿池稳定币。

## 攻击分析
![](https://assets.blocksec.com/frontend/blocksec-strapi-online/image_attack_steps_en_9324859b07.png)

1. 使用 Fortube 的 Flashloan 借入 50,000 BUSD
2. 从 Ellipsis 将 50,000 BUSD 兑换成 50,351 fUSDT。
3. 调用 MetaSwap的swap函数，将 50,351 fUSDT 换成 36,959 Nerve 3-LP，滑点相对较大。
4. 使用上一步收到的 LP 代币调用 Nerve.3pool 的 removeLiquidityOneCoin 功能，去除 BUSD 的流动性，即 5.37,071 BUSD。
5. 调用 MetaSwap 函数将 BUSD 兑换成 fUSDT，获得 51,494 fUSDT。


简单来说攻击者先贷款矿池稳定币（fUSDT）使用 swap 函数兑换 LP 代币，此时因为swap函数没有考虑LP代币的虚拟价值（应该除以虚拟价格），系统低估LP代币价值，攻击者多获得 LP 代币，之后在 Nerve 3Pool 将 LP 代币按照真实价值兑换为 BUSD （底层稳定币），最后调用 swapUnderlying 函数将 BUSD 换回 fUSDT，额外多出了多得的 LP 代币的钱。重复直到榨干池子的流动性。

## 相关合约地址

相关合约地址如下：
MetaSwap：0xd0fBF0A224563D5fFc8A57e4fdA6Ae080EbCf3D3
SwapUtils：0x02338Ee742ddCDe44488640F4edf1Aa947E670E7